name: CI Front-End

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm install --legacy-peer-deps

    - name: Install missing Babel plugin
      run: npm install --save-dev @babel/plugin-proposal-private-property-in-object --legacy-peer-deps

    - name: Build React app
      run: |
        # Configure Puppeteer to run without sandbox in CI environment
        PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
        NODE_OPTIONS=--max_old_space_size=4096
        PUPPETEER_EXECUTABLE_PATH=/usr/bin/google-chrome-stable
        npm run build
      env:
        CI: true
        PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: true
        PUPPETEER_NO_SANDBOX: true

    - name: Deploy via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: choucas.o2switch.net
        username: rame5605
        password: ${{ secrets.FTP_PASSWORD }}
        protocol: ftp
        port: 21
        local-dir: ./build/
        server-dir: /testfront.fr/
        state-name: .ftp-deploy-sync-state.json
        dangerous-clean-slate: false
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          .gitignore
          README.md
          .env.local
          .env.development
          .env.test
          .env.production
          yarn.lock
          package-lock.json
          .DS_Store
          .editorconfig
          .ftp-deploy-sync-state.json
        log-level: verbose
