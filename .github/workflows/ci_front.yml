name: CI Front-End

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install Puppeteer dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgbm-dev libasound2 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils

    - name: Install dependencies
      run: npm install --legacy-peer-deps

    - name: Install additional dependencies
      run: npm install cross-env --legacy-peer-deps --save-dev

    - name: Build React app
      run: npm run build
      env:
        NODE_ENV: production
        PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: true
        REACT_SNAP_SKIP_FETCH_POLYFILL: true
        REACT_SNAP_PUPPETEER_ARGS: '["--no-sandbox", "--disable-setuid-sandbox", "--disable-dev-shm-usage"]'
        REACT_SNAP_TIMEOUT: 60000

    - name: Deploy via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: choucas.o2switch.net
        username: rame5605
        password: ${{ secrets.FTP_PASSWORD }}
        protocol: ftp
        port: 21
        local-dir: ./build/
        server-dir: /testfront.fr/
        state-name: .ftp-deploy-sync-state.json
        dangerous-clean-slate: false
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          .gitignore
          README.md
          .env.local
          .env.development
          .env.test
          .env.production
          yarn.lock
          package-lock.json
          .DS_Store
          .editorconfig
          .ftp-deploy-sync-state.json
        log-level: verbose